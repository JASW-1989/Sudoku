<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ê•µÁ∞°Êï∏Áç® Pro Master v2.1</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }
        .animate-shake { animation: shake 0.2s ease-in-out infinite; }
        
        /* ÈáùÂ∞çË°åÂãïÁ´ØÂÑ™ÂåñÈªûÊìäÁØÑÂúç */
        .touch-pad { touch-action: manipulation; }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        // --- ÂÖßÂµåÂúñÊ®ôÂÖÉ‰ª∂ ---
        const Icons = {
            Sun: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/></svg>,
            Moon: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
            Coffee: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 8h1a4 4 0 1 1 0 8h-1M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" y1="2" x2="6" y2="4"/><line x1="10" y1="2" x2="10" y2="4"/><line x1="14" y1="2" x2="14" y2="4"/></svg>,
            Undo: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M3 7V5c0-1.1.9-2 2-2h2"/><path d="M3 7h2c1.1 0 2 .9 2 2v2"/><path d="M21 7V5c0-1.1-.9-2-2-2h-2"/><path d="M21 7h-2c-1.1 0-2 .9-2 2v2"/><path d="M12 22a9 9 0 0 0 9-9 9 9 0 0 0-9-9 9 9 0 0 0-9 9 9 9 0 0 0 9 9Z"/><path d="m8 13 4-4 4 4"/></svg>,
            Eraser: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/><path d="m5 11 9 9"/></svg>,
            Pencil: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>,
            Lightbulb: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>,
            Graduation: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>,
            Alert: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            Play: (p) => <svg width={p.size||24} height={p.size||24} viewBox="0 0 24 24" fill="currentColor"><path d="m7 4 12 8-12 8V4z"/></svg>,
            Pause: (p) => <svg width={p.size||24} height={p.size||24} viewBox="0 0 24 24" fill="currentColor"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>
        };

        // --- Êï∏Áç®ÂºïÊìé ---
        const EMPTY = 0;
        const range = (n) => Array.from({ length: n }, (_, i) => i);
        const getCoords = (idx) => {
            const r = Math.floor(idx / 9);
            const c = idx % 9;
            const b = Math.floor(r / 3) * 3 + Math.floor(c / 3);
            return { r, c, b };
        };

        const isValid = (board, idx, num) => {
            const { r, c, b } = getCoords(idx);
            for (let i = 0; i < 81; i++) {
                const t = getCoords(i);
                if (i !== idx && board[i] === num && (r === t.r || c === t.c || b === t.b)) return false;
            }
            return true;
        };

        const solve = (board) => {
            for (let i = 0; i < 81; i++) {
                if (board[i] === EMPTY) {
                    for (let num = 1; num <= 9; num++) {
                        if (isValid(board, i, num)) {
                            board[i] = num;
                            if (solve(board)) return true;
                            board[i] = EMPTY;
                        }
                    }
                    return false;
                }
            }
            return true;
        };

        const generateGame = (holes) => {
            const board = Array(81).fill(EMPTY);
            const firstRow = range(9).map(i => i + 1).sort(() => Math.random() - 0.5);
            for (let i = 0; i < 9; i++) board[i] = firstRow[i];
            solve(board);
            const solution = [...board];
            const puzzle = [...board];
            let removed = 0;
            while (removed < holes) {
                const idx = Math.floor(Math.random() * 81);
                if (puzzle[idx] !== EMPTY) {
                    puzzle[idx] = EMPTY;
                    removed++;
                }
            }
            return { puzzle, solution };
        };

        // --- ‰∏ªÊáâÁî®Á®ãÂºè ---
        function App() {
            const [board, setBoard] = useState(Array(81).fill(EMPTY));
            const [initial, setInitial] = useState(Array(81).fill(false));
            const [solution, setSolution] = useState(Array(81).fill(EMPTY));
            const [notes, setNotes] = useState(Array(81).fill().map(() => []));
            const [history, setHistory] = useState([]);
            const [selectedIdx, setSelectedIdx] = useState(null);
            const [focusNum, setFocusNum] = useState(null);
            const [mistakes, setMistakes] = useState(0);
            const [difficulty, setDifficulty] = useState('‰∏≠Á≠â');
            const [timer, setTimer] = useState(0);
            const [status, setStatus] = useState('playing');
            const [isNoteMode, setIsNoteMode] = useState(false);
            const [theme, setTheme] = useState('light');
            const [errorIdx, setErrorIdx] = useState(null); 
            const [mentorHint, setMentorHint] = useState(null);

            const DIFFICULTY_CONFIG = { 'ÂÖ•ÈñÄ': 26, 'Á∞°ÂñÆ': 36, '‰∏≠Á≠â': 46, 'Âõ∞Èõ£': 54, 'Â∞àÂÆ∂': 60 };

            const themes = {
                light: { 
                    bg: 'bg-[#FDFDFD]', card: 'bg-white', text: 'text-slate-900', 
                    gridBg: 'bg-slate-300', cell: 'bg-white', 
                    fixedText: 'text-black font-black', userInputText: 'text-indigo-600 font-bold',
                    noteText: 'text-indigo-500 font-black', // ÊèêÈ´òÁ≠ÜË®òÂ∞çÊØîËàáÁ≤óÂ∫¶
                    sel: 'bg-indigo-600 text-white shadow-indigo-200',
                    same: 'bg-indigo-100 text-indigo-900', 
                    excl: 'bg-slate-100 opacity-40', 
                    poten: 'bg-white ring-[1.5px] ring-amber-400 z-10',
                    hintTarget: 'bg-emerald-50 ring-[3px] ring-emerald-400 z-20 shadow-lg',
                    btn: 'bg-white border-slate-100 text-slate-600 shadow-sm hover:border-indigo-300',
                    line: '#334155' 
                },
                dark: { 
                    bg: 'bg-[#0A0A0C]', card: 'bg-[#16161A]', text: 'text-slate-100', 
                    gridBg: 'bg-slate-700', cell: 'bg-[#16161A]', 
                    fixedText: 'text-white font-black', userInputText: 'text-indigo-400 font-bold',
                    noteText: 'text-amber-300/80 font-black', // ÊöóËâ≤Ê®°Âºè‰ΩøÁî®Áê•ÁèÄËâ≤Âä†Âº∑Ëæ®Ë≠ò
                    sel: 'bg-indigo-500 text-white shadow-black/50',
                    same: 'bg-indigo-900/40 text-indigo-300', 
                    excl: 'bg-slate-900 opacity-30', 
                    poten: 'bg-slate-900 ring-[1.5px] ring-amber-500 z-10',
                    hintTarget: 'bg-emerald-900/40 ring-[3px] ring-emerald-500 z-20 shadow-[0_0_15px_rgba(16,185,129,0.3)]',
                    btn: 'bg-slate-800 border-slate-700 text-slate-300',
                    line: '#e2e8f0'
                },
                sepia: { 
                    bg: 'bg-[#F2E8D5]', card: 'bg-[#FDF6E3]', text: 'text-[#5b4636]', 
                    gridBg: 'bg-[#D5C4A1]', cell: 'bg-[#FDF6E3]', 
                    fixedText: 'text-[#2d2118] font-black', userInputText: 'text-[#B58900] font-bold',
                    noteText: 'text-orange-800 font-black', // Ê∑±Ê©òË§êËâ≤
                    sel: 'bg-[#B58900] text-white shadow-orange-900/10',
                    same: 'bg-[#EEE8D5] text-[#856404]', 
                    excl: 'bg-[#E5D9C5] opacity-60', 
                    poten: 'bg-[#FDF6E3] ring-[1.5px] ring-orange-400 z-10',
                    hintTarget: 'bg-[#D1FAE5] ring-[3px] ring-emerald-600 z-20',
                    btn: 'bg-[#FDF6E3] border-[#EEE8D5] text-[#5b4636]',
                    line: '#5b4636'
                }
            };
            const T = themes[theme];

            const initGame = useCallback((level = difficulty) => {
                const holes = DIFFICULTY_CONFIG[level];
                const { puzzle, solution: sol } = generateGame(holes);
                setBoard(puzzle); setSolution(sol); setInitial(puzzle.map(v => v !== EMPTY));
                setNotes(Array(81).fill().map(() => [])); setHistory([]); setMistakes(0); setTimer(0);
                setSelectedIdx(null); setFocusNum(null); setStatus('playing'); setMentorHint(null);
            }, [difficulty]);

            useEffect(() => initGame(), []);
            useEffect(() => {
                let itv;
                if (status === 'playing') itv = setInterval(() => setTimer(s => s + 1), 1000);
                return () => clearInterval(itv);
            }, [status]);

            const analysis = useMemo(() => {
                const activeNum = focusNum || (selectedIdx !== null ? board[selectedIdx] : null);
                const excluded = new Set(); const potentials = new Set(); const same = new Set();
                if (!activeNum || activeNum === EMPTY) return { excluded, potentials, same, activeNum: null };
                for (let i = 0; i < 81; i++) {
                    if (board[i] === activeNum) {
                        same.add(i);
                        const { r, c, b } = getCoords(i);
                        for (let j = 0; j < 81; j++) {
                            const t = getCoords(j);
                            if (t.r === r || t.c === c || t.b === b) excluded.add(j);
                        }
                    }
                }
                for (let i = 0; i < 81; i++) {
                    if (board[i] === EMPTY && !excluded.has(i)) potentials.add(i);
                }
                return { excluded, potentials, same, activeNum };
            }, [board, selectedIdx, focusNum]);

            // --- Á≤æÈÄ≤ÂæåÁöÑÊô∫ÊÖßÂÆ∂ÊïôÈÇèËºØ ---
            const provideSmartHint = () => {
                // 1. ÂÅµÊ∏¨ÈåØË™§
                for (let i = 0; i < 81; i++) {
                    if (board[i] !== EMPTY && board[i] !== solution[i]) {
                        setMentorHint({ idx: i, msg: "ÂìéÂëÄÔºÅÈÄôÊ†ºÂ°´ÂØ´ÁöÑÊï∏Â≠ó‰∏¶‰∏çÊ≠£Á¢∫ÔºåÂª∫Ë≠∞ÂÖà‰øÆÊ≠£ÂÆÉ‰ª•ÂÖçÂπ≤ÊìæÂæåÁ∫åÊé®ÁêÜ„ÄÇ", type: 'error' });
                        setSelectedIdx(i); return;
                    }
                }

                // 2. ÈÇèËºØ AÔºöÂîØ‰∏ÄÈ§òÊï∏ (Naked Single) - ÊêúÂ∞ãÊâÄÊúâÁ©∫Ê†º‰∏≠ÔºåÂîØ‰∏ÄËÉΩÂ°´ÂÖ•ÁöÑÊï∏Â≠ó
                for (let i = 0; i < 81; i++) {
                    if (board[i] === EMPTY) {
                        let validNums = [];
                        for (let n = 1; n <= 9; n++) if (isValid(board, i, n)) validNums.push(n);
                        if (validNums.length === 1) {
                            setMentorHint({ idx: i, msg: `ËßÄÂØüÈÄôÊ†ºÊâÄÂú®ÁöÑË°å„ÄÅÂàóËàáÂÆÆÊ†ºÔºå‰Ω†ÊúÉÁôºÁèæÂÆÉÂè™Ââ©‰∏ã‰∏ÄÂÄãÂêàÊ≥ïÁöÑÊï∏Â≠óÔºö${validNums[0]}„ÄÇ`, type: 'logic' });
                            setSelectedIdx(i); setFocusNum(null); return;
                        }
                    }
                }

                // 3. ÈÇèËºØ BÔºöÈö±ÊÄßÂñÆ‰∏ÄÊï∏ (Hidden Single) - Âú®‰∏ÄÂÄãÂñÆÂÖÉÔºàË°å„ÄÅÂàó„ÄÅÂÆÆÔºâ‰∏≠ÔºåÊüêÊï∏Â≠óÂè™ÊúâÂîØ‰∏ÄÁöÑÊ†ºÂ≠êËÉΩÂ°´
                const findHidden = () => {
                    const units = [];
                    // Rows
                    for (let r = 0; r < 9; r++) units.push(range(9).map(c => r * 9 + c));
                    // Cols
                    for (let c = 0; c < 9; c++) units.push(range(9).map(r => r * 9 + c));
                    // Boxes
                    for (let b = 0; b < 9; b++) {
                        const box = [];
                        const br = Math.floor(b / 3) * 3; const bc = (b % 3) * 3;
                        for (let r = 0; r < 3; r++) for (let c = 0; c < 3; c++) box.push((br + r) * 9 + (bc + c));
                        units.push(box);
                    }

                    for (const unit of units) {
                        for (let n = 1; n <= 9; n++) {
                            const possibleCells = unit.filter(idx => board[idx] === EMPTY && isValid(board, idx, n));
                            if (possibleCells.length === 1) {
                                const targetIdx = possibleCells[0];
                                const typeName = unit[0] % 9 === unit[1] % 9 ? "ÈÄô‰∏ÄÂàó" : (Math.floor(unit[0]/9) === Math.floor(unit[1]/9) ? "ÈÄô‰∏ÄË°å" : "ÈÄôÂÄã‰πùÂÆÆÊ†º");
                                return { idx: targetIdx, n, typeName };
                            }
                        }
                    }
                    return null;
                };

                const hiddenResult = findHidden();
                if (hiddenResult) {
                    setMentorHint({ idx: hiddenResult.idx, msg: `Âú®${hiddenResult.typeName}‰∏≠ÔºåÊï∏Â≠ó ${hiddenResult.n} Âè™ÊúâÈÄô‰∏ÄÂÄã‰ΩçÁΩÆËÉΩÊîæÔºåÈÄôÊòØ‰∏ÄÂÄãÁµï‰Ω≥ÁöÑÁ™ÅÁ†¥Âè£ÔºÅ`, type: 'logic' });
                    setSelectedIdx(hiddenResult.idx); setFocusNum(null); return;
                }

                // 4. ÊúÄÂæåÊâãÊÆµÔºöÁµ¶‰∫àÂèØËÉΩÊÄßÊúÄÂ∞ëÁöÑÊèêÁ§∫
                let bestIdx = -1; let minP = 10;
                for (let i = 0; i < 81; i++) {
                    if (board[i] === EMPTY) {
                        let count = 0; for (let n = 1; n <= 9; n++) if (isValid(board, i, n)) count++;
                        if (count > 0 && count < minP) { minP = count; bestIdx = i; }
                    }
                }
                if (bestIdx !== -1) {
                    setMentorHint({ idx: bestIdx, msg: "ÈÄôÊ†ºÁöÑÂÄôÈÅ∏Êï∏Â≠óÂ∑≤Á∂ì‰∏çÂ§ö‰∫ÜÔºåË©¶ËëóÊ†πÊìöË°åÂàóÊéíÈô§Ê≥ïÊé®Êï≤ÁúãÁúãÔºü", type: 'guide' });
                    setSelectedIdx(bestIdx); setFocusNum(null);
                }
            };

            const handleInput = (num) => {
                if (status !== 'playing') return;
                if (num === 'HINT') { provideSmartHint(); return; }
                setMentorHint(null);

                if (selectedIdx === null) { setFocusNum(num === focusNum ? null : num); return; }
                if (initial[selectedIdx]) { setFocusNum(board[selectedIdx]); return; }

                setHistory(prev => [...prev.slice(-19), { board: [...board], notes: notes.map(n => [...n]), mistakes }]);

                if (num === 'ERASE') {
                    setBoard(b => { const nb = [...b]; nb[selectedIdx] = EMPTY; return nb; });
                    setNotes(n => { const nn = [...n]; nn[selectedIdx] = []; return nn; });
                    return;
                }

                if (isNoteMode) {
                    if (board[selectedIdx] !== EMPTY) return;
                    setNotes(n => {
                        const nn = [...n]; const cur = nn[selectedIdx];
                        nn[selectedIdx] = cur.includes(num) ? cur.filter(v => v !== num) : [...cur, num].sort();
                        return nn;
                    });
                } else {
                    if (solution[selectedIdx] === num) {
                        setBoard(b => { const nb = [...b]; nb[selectedIdx] = num; return nb; });
                        setFocusNum(num);
                        const { r, c, b } = getCoords(selectedIdx);
                        setNotes(ns => ns.map((n, i) => {
                            const ic = getCoords(i);
                            return (ic.r === r || ic.c === c || ic.b === b) ? n.filter(v => v !== num) : n;
                        }));
                        if (board.every((v, i) => i === selectedIdx ? num !== EMPTY : v !== EMPTY)) setStatus('won');
                    } else {
                        setErrorIdx(selectedIdx); setTimeout(() => setErrorIdx(null), 500);
                        setMistakes(m => { if (m + 1 >= 5) setStatus('lost'); return m + 1; });
                    }
                }
            };

            const toggleDifficulty = () => {
                const list = ['ÂÖ•ÈñÄ', 'Á∞°ÂñÆ', '‰∏≠Á≠â', 'Âõ∞Èõ£', 'Â∞àÂÆ∂'];
                const nextIdx = (list.indexOf(difficulty) + 1) % list.length;
                setDifficulty(list[nextIdx]); initGame(list[nextIdx]);
            };

            return (
                <div className={`min-h-[100dvh] ${T.bg} ${T.text} flex flex-col items-center p-5 transition-all duration-500 font-sans select-none overflow-x-hidden`}>
                    
                    {/* Header */}
                    <div className="w-full max-w-[440px] flex justify-between items-center mb-6 px-1">
                        <div className="flex bg-black/5 dark:bg-white/5 backdrop-blur-md p-1 rounded-2xl border border-white/10 shadow-sm">
                            {['light', 'dark', 'sepia'].map(t => (
                                <button key={t} onClick={() => setTheme(t)} className={`p-2.5 rounded-xl transition-all duration-300 ${theme === t ? 'bg-white dark:bg-slate-700 shadow-lg scale-110' : 'opacity-30 hover:opacity-60'}`}>
                                    {t === 'light' ? <Icons.Sun /> : t === 'dark' ? <Icons.Moon /> : <Icons.Coffee />}
                                </button>
                            ))}
                        </div>
                        <div className="flex flex-col items-end">
                            <span className="text-[10px] font-black opacity-30 uppercase tracking-[0.3em] mb-1">Time Elapsed</span>
                            <p className="text-3xl font-mono font-black tracking-tighter leading-none">{Math.floor(timer/60)}:{(timer%60).toString().padStart(2,'0')}</p>
                        </div>
                    </div>

                    {/* Stats */}
                    <div className="w-full max-w-[440px] flex justify-between items-end mb-6 px-1">
                        <div className="space-y-1">
                            <h1 className="text-3xl font-black italic tracking-tighter leading-none flex items-center gap-2">
                                SUDOKU <span className="px-2 py-0.5 bg-indigo-600 text-white text-[12px] not-italic rounded-md shadow-lg">PRO</span>
                            </h1>
                            <button onClick={toggleDifficulty} className="text-xs font-black text-indigo-600 dark:text-indigo-400 uppercase tracking-widest hover:opacity-70 flex items-center gap-1">
                                <span className="opacity-40">Lv:</span> {difficulty}
                            </button>
                        </div>
                        <div className={`px-4 py-2 rounded-2xl text-[11px] font-black shadow-xl flex items-center gap-2 transition-colors ${mistakes >= 4 ? 'bg-red-500 text-white animate-pulse' : 'bg-white dark:bg-slate-800 text-slate-500 border border-slate-100 dark:border-slate-700'}`}>
                            <Icons.Alert /> MISTAKES {mistakes}/5
                        </div>
                    </div>

                    {/* Mentor Hint Message */}
                    <div className="w-full max-w-[440px] h-[80px] mb-4">
                        {mentorHint && (
                            <div className="animate-in fade-in slide-in-from-bottom-2 duration-300 h-full">
                                <div className={`p-4 h-full rounded-xl shadow-lg border-l-4 flex items-center gap-3 ${mentorHint.type === 'error' ? 'bg-red-50 border-red-500 text-red-800' : 'bg-emerald-50 border-emerald-500 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-200'}`}>
                                    {mentorHint.type === 'error' ? <Icons.Alert /> : <Icons.Graduation />}
                                    <div className="overflow-hidden">
                                        <p className="text-[10px] font-bold uppercase tracking-widest opacity-60 leading-none mb-1">{mentorHint.type === 'error' ? 'Found Mistake' : 'Logic Guide'}</p>
                                        <p className="text-sm font-bold leading-tight line-clamp-2">{mentorHint.msg}</p>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Sudoku Grid */}
                    <div className={`w-full max-w-[440px] aspect-square relative shadow-2xl rounded-xl overflow-hidden mb-8 border-[3.5px] ${theme === 'light' ? 'border-slate-800' : 'border-slate-700'}`}>
                        <div className={`absolute inset-0 grid grid-cols-9 grid-rows-9 gap-[1px] ${T.gridBg} p-[1px]`}>
                            {range(81).map(i => {
                                const val = board[i]; const isSelected = selectedIdx === i; const isSame = analysis.same.has(i); const isPotential = analysis.potentials.has(i); const isExcluded = analysis.excluded.has(i); const isErr = errorIdx === i;
                                const { r, c, b } = getCoords(i);
                                const isHintTarget = mentorHint && mentorHint.idx === i;
                                const isRel = !analysis.activeNum && selectedIdx !== null && !isSelected && (getCoords(selectedIdx).r === r || getCoords(selectedIdx).c === c || getCoords(selectedIdx).b === b);
                                
                                let cellStyle = T.cell; let textStyle = initial[i] ? T.fixedText : T.userInputText;
                                if (isHintTarget) cellStyle = T.hintTarget;
                                else if (isSelected) { cellStyle = T.sel; textStyle = 'text-white font-black'; }
                                else if (isSame) { cellStyle = T.same; }
                                else if (isPotential) { cellStyle = T.poten; }
                                else if (isExcluded) { cellStyle = T.excl; textStyle += ' opacity-40'; }
                                else if (isRel) { cellStyle = 'bg-slate-50 dark:bg-slate-800/30'; }
                                if (isErr) cellStyle = 'bg-red-500 text-white z-50';

                                return (
                                    <div key={i} onClick={() => { setSelectedIdx(i); setFocusNum(val || null); if(val) setMentorHint(null); }} className={`relative ${cellStyle} flex items-center justify-center cursor-pointer transition-all duration-200 overflow-hidden ${isErr ? 'animate-shake' : ''} ${isHintTarget ? 'animate-pulse' : ''}`}>
                                        <span className={`relative z-30 pointer-events-none text-2xl sm:text-4xl transition-transform duration-300 ${textStyle} ${isSelected ? 'scale-110' : ''}`}>
                                            {val !== EMPTY ? val : ''}
                                        </span>
                                        {val === EMPTY && (
                                            <div className="absolute inset-0 grid grid-cols-3 p-1 z-20 pointer-events-none">
                                                {range(9).map(n => (
                                                    <div key={n} className={`flex items-center justify-center text-[9px] sm:text-[11px] leading-none transition-all ${notes[i].includes(n+1) ? `${T.noteText} opacity-100 scale-125` : 'opacity-0'}`}>
                                                        {n+1}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                        {isPotential && <div className="absolute top-1.5 right-1.5 w-1.5 h-1.5 bg-amber-400 rounded-full animate-pulse z-40 shadow-sm" />}
                                    </div>
                                );
                            })}
                        </div>
                        <svg className="absolute inset-0 w-full h-full pointer-events-none z-50" viewBox="0 0 90 90" preserveAspectRatio="none">
                            <line x1="30" y1="0" x2="30" y2="90" stroke={T.line} strokeWidth="1.5" /><line x1="60" y1="0" x2="60" y2="90" stroke={T.line} strokeWidth="1.5" /><line x1="0" y1="30" x2="90" y2="30" stroke={T.line} strokeWidth="1.5" /><line x1="0" y1="60" x2="90" y2="60" stroke={T.line} strokeWidth="1.5" />
                        </svg>
                    </div>

                    {/* Action Controls */}
                    <div className="w-full max-w-[440px] flex gap-3 mb-8 px-1">
                        <button onClick={() => setHistory(h => { if(h.length===0) return h; const l=h[h.length-1]; setBoard(l.board); setNotes(l.notes); setMistakes(l.mistakes); return h.slice(0,-1); })} disabled={history.length === 0} className={`flex-1 flex flex-col items-center py-4 rounded-3xl border-2 transition-all ${T.btn} ${history.length === 0 ? 'opacity-10 grayscale' : 'active:scale-90'}`}><Icons.Undo /><span className="text-[9px] font-black mt-1.5 uppercase tracking-tighter">Undo</span></button>
                        <button onClick={() => handleInput('ERASE')} className={`flex-1 flex flex-col items-center py-4 rounded-3xl border-2 transition-all ${T.btn} hover:text-red-500 hover:border-red-200 active:scale-90`}><Icons.Eraser /><span className="text-[9px] font-black mt-1.5 uppercase tracking-tighter">Erase</span></button>
                        <button onClick={() => setIsNoteMode(!isNoteMode)} className={`flex-1 flex flex-col items-center py-4 rounded-3xl border-2 transition-all shadow-md active:scale-90 ${isNoteMode ? 'bg-indigo-600 border-indigo-600 text-white shadow-indigo-200' : `${T.btn}`}`}><Icons.Pencil /><span className="text-[9px] font-black mt-1.5 uppercase tracking-tighter">Note {isNoteMode ? 'ON' : 'OFF'}</span></button>
                        <button onClick={() => handleInput('HINT')} className={`flex-1 flex flex-col items-center py-4 rounded-3xl border-2 transition-all ${T.btn} hover:text-emerald-600 hover:border-emerald-200 active:scale-90 ${mentorHint ? 'border-emerald-400 bg-emerald-50 text-emerald-700' : ''}`}>
                            <Icons.Lightbulb />
                            <span className="text-[9px] font-black mt-1.5 uppercase tracking-tighter">Guide</span>
                        </button>
                    </div>

                    {/* Numeric Input Pad */}
                    <div className="w-full max-w-[440px] grid grid-cols-5 gap-4 pb-12 px-1 touch-pad">
                        {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => {
                            const isFocused = focusNum === num;
                            return <button key={num} onClick={() => handleInput(num)} className={`relative aspect-square rounded-[2rem] text-3xl font-black shadow-xl transition-all duration-300 flex flex-col items-center justify-center border-b-8 active:border-b-0 active:translate-y-2 ${isFocused ? 'bg-indigo-600 text-white border-indigo-800 shadow-indigo-500/40 -translate-y-2 scale-110' : `bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-800 dark:text-slate-200 hover:border-indigo-300`}`}>{num}</button>;
                        })}
                        <button onClick={() => setStatus(status==='paused'?'playing':'paused')} className="aspect-square rounded-[2rem] bg-slate-900 dark:bg-white text-white dark:text-slate-900 shadow-2xl flex items-center justify-center active:scale-90 transition-transform">
                            {status === 'paused' ? <Icons.Play size={30} /> : <Icons.Pause size={30} />}
                        </button>
                    </div>

                    {/* Overlays */}
                    {status !== 'playing' && status !== 'paused' && (
                        <div className="fixed inset-0 bg-slate-950/95 backdrop-blur-xl flex flex-col items-center justify-center z-[100] text-white p-10 text-center animate-in zoom-in-95 duration-500">
                            <div className="mb-10 text-6xl">üèÜ</div>
                            <h2 className="text-4xl font-black italic tracking-tighter mb-4">{status === 'won' ? 'SUCCESS' : 'GAME OVER'}</h2>
                            <p className="text-sm opacity-50 uppercase tracking-[0.3em] mb-12">{status === 'won' ? 'Congratulations on solving the puzzle' : 'Limit of mistakes reached'}</p>
                            <button onClick={() => initGame()} className="w-full max-w-xs py-5 bg-indigo-600 text-white rounded-3xl font-black shadow-2xl active:scale-95 transition-all text-lg uppercase tracking-widest">New Mission</button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
